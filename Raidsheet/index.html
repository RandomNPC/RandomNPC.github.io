<!DOCTYPE html>
<html>
	<link rel="stylesheet" href="styles.css">
	<link href="https://fonts.googleapis.com/css?family=Chivo" rel="stylesheet">
	<script src="jquery-3.1.1.js"></script>
	<script src="jquery.js"></script>
	<script src="jquery-ui.js"></script>
	<script>
		$(document).ready(function(){
			$('.beastmaster, .bmroles').sortable(
				{
					connectWith: '.bmroles, .beastmaster',
					cursor: 'pointer',
					revert: true,
					receive: function(event, ui){
						var $origin = ui.sender;
						var $destination = $(this);

						//Role List -> Roster
						$destination.children(".placeholder").remove();

						//Roster -> Role List or Roster -> Roster
						if(!$origin.hasClass("bmroles")){ //Stop this from filling the Role List
							if($origin.children("li").length === 0){ //Prevent furthur DPS placeholders here
								$origin.append("<li class=\'placeholder\'>DPS</li>");
							}
						}
						UpdateBBCode();
					}
				});


			$('.yakamaru, .yakaroles').sortable(
				{
					connectWith: '.yakamaru, .yakaroles',
					cursor: 'pointer',
					revert: true,
					receive: function(event, ui){
						var $origin = ui.sender;
						var $destination = $(this);

						//Role List -> Roster
						$destination.children(".placeholder").remove();

						//Roster -> Role List or Roster -> Roster
						if(!$origin.hasClass("yakaroles")){ //Stop this from filling the Role List
							if($origin.children("li").length === 0){ //Prevent furthur DPS placeholders here
								$origin.append("<li class=\'placeholder\'>DPS</li>");
							}
						}
						UpdateBBCode();
					}
				}
			);

			$(".participant").change(function(){
				UpdateBBCode();
			});

			$.each($('.roster .beastmaster, .roster .yakamaru'),function(index, value){
				$(this).append("<li class=\'placeholder\'>DPS</li>");
			});

			function UpdateBBCode(){
				$("#textarea").val("");
				var $rows = $('.roster li, .roster input').map(function(){
					return $(this);
				});

				var bmroleCount = 0;
				var yakaroleCount = 0;
				var bmoutput = "";
				var yakaoutput = "";
				var display = "";

				$.each($rows,function(index,value){
					var $cell = value;
					if($cell.hasClass("participant"))
					{
						if(bmoutput != "")
						{
							display +=
							"[td][center]"+ yakaoutput +"[/center][/td]"  + "\n" +
							"[td][center]"+ bmoutput +"[/center][/td]"  + "\n" +
							"[/tr]"  + "\n";

							bmoutput = "";
							yakaoutput = "";
						}

						bmroleCount = 0;
						yakaroleCount = 0;

						display +=
						"[tr]"  + "\n" +
						"[td][center]" + $cell.val() + "[/center][/td]"  + "\n";
					}
					else if($cell.parent().hasClass("beastmaster")){
						bmoutput += (bmroleCount > 0) ? " + " + $cell.context.textContent : $cell.context.textContent;
						bmroleCount++;
					}
					else if($cell.parent().hasClass("yakamaru")){
						yakaoutput += (yakaroleCount > 0) ? " + " + $cell.context.textContent : $cell.context.textContent;
						yakaroleCount++;
					}
				});

				display +=
				"[td][center]"+ yakaoutput +"[/center][/td]"  + "\n" +
				"[td][center]"+ bmoutput +"[/center][/td]"  + "\n" +
				"[/tr]"  + "\n";

				$("textarea").val(
					"[table]" + "\n" +
					"[tr]" + "\n" +
					"[th][center]0?:?? GMT, ???, ??? ???[/center][/th]" + "\n" +
					"[td][center]Hosted by ???[/center][/td]" + "\n" +
					"[/tr]" + "\n" +
					"[tr]" + "\n" +
					"[td] [/td]" + "\n" +
					"[/tr]" + "\n" +
					"[/table]" + "\n" +
					"(Names marked with a * are people learning roles for the first time.)" + "\n" +
					"[table]" + "\n" +
					"[tr]" +" [/tr]" + "\n" +
					"[tr]" + "\n" +
					"[th]Name[/th]" + "\n" +
					"[th]Yakamaru[/th]" + "\n" +
					"[th]Beastmaster[/th]" + "\n" +
					"[/tr]"+ "\n"
					+ display + "[/table]");
			}
		});


	</script>
	<body>
	<div id='container'>
		<div id='master'>
			<table class='roster' cellspacing="0">
				<tr>
					<td>Name</td>
					<td>Beastmaster</td>
					<td>Yakamaru</td>
				</tr>
				<tr>
					<td><input type='text' class="participant"></td>
					<td class='beastmaster'></td>
					<td class='yakamaru'></td>
				</tr>
				<tr>
					<td><input type='text' class="participant"></td>
					<td class='beastmaster'></td>
					<td class='yakamaru'></td>
				</tr>
				<tr>
					<td><input type='text' class="participant"></td>
					<td class='beastmaster'></td>
					<td class='yakamaru'></td>
				</tr>
				<tr>
					<td><input type='text' class="participant"></td>
					<td class='beastmaster'></td>
					<td class='yakamaru'></td>
				</tr>
				<tr>
					<td><input type='text' class="participant"></td>
					<td class='beastmaster'></td>
					<td class='yakamaru'></td>
				</tr>
				<tr>
					<td><input type='text' class="participant"></td>
					<td class='beastmaster'></td>
					<td class='yakamaru'></td>
				</tr>
				<tr>
					<td><input type='text' class="participant"></td>
					<td class='beastmaster'></td>
					<td class='yakamaru'></td>
				</tr>
				<tr>
					<td><input type='text' class="participant"></td>
					<td class='beastmaster'></td>
					<td class='yakamaru'></td>
				</tr>
				<tr>
					<td><input type='text' class="participant"></td>
					<td class='beastmaster'></td>
					<td class='yakamaru'></td>
				</tr>
				<tr>
					<td><input type='text' class="participant"></td>
					<td class='beastmaster'></td>
					<td class='yakamaru'></td>
				</tr>
			</table>
		</div>
		<div id='roles'>
			<table class='rolelist'>
				<tr><td class='bmroles'><li>BM Base Tank</li></td></tr>
				<tr><td class='bmroles'><li>Pet Tank 1/3</li></td></tr>
				<tr><td class='bmroles'><li>Pet Tank 2</li></td></tr>
				<tr><td class='bmroles'><li>Backup Tank</li></td></tr>
				<tr><td class='bmroles'><li>North Chargers</li></td></tr>
				<tr><td class='bmroles'><li>South Chargers</li></td></tr>
				<tr><td class='yakaroles'><li>Yaka Base Tank</li></td></tr>
				<tr><td class='yakaroles'><li>North Tank</li></td></tr>
				<tr><td class='yakaroles'><li>Poison Tank</li></td></tr>
				<tr><td class='yakaroles'><li>Double Poison</li></td></tr>
				<tr><td class='yakaroles'><li>Shark 10</li></td></tr>
				<tr><td class='yakaroles'><li>Stun 5</li></td></tr>
				<tr><td class='yakaroles'><li>Stun 5</li></td></tr>
				<tr><td class='yakaroles'><li>Stun 0</li></td></tr>
				<tr><td class='yakaroles'><li>CPR</li></td></tr>
				<tr><td class='yakaroles'><li>Wrangler</li></td></tr>
				<tr><td class='yakaroles'><li>Main Stun</li></td></tr>
				<tr><td class='yakaroles'><li>Backup Stun</li></td></tr>
			</table>
		</div>
	</div>
	<div id='output'>
		<textarea id="textarea"></textarea>
	</div>
	</body>
</html>
